## 模型设计
二级留言跟留言模型类似，修改 lib/mongo.js，添加如下代码：

**lib/mongo.js**
```js
// 留言2
exports.Comment2 = mongolass.model('Comment2', {
  author: { type: Mongolass.Types.ObjectId, required: true },
  content: { type: 'string', required: true },
  postId: { type: Mongolass.Types.ObjectId, required: true },
  commentId: { type: Mongolass.Types.ObjectId, required: true }
})
exports.Comment2.index({ commentId: 1, _id: 1 }).exec()// 通过留言 id 获取该留言下所有留言，按留言创建时间升序
```
## 页面设计
首先增加显示二级评论和录入框的组件，新建 views\components\comment2s.ejs

**views\components\comment2s.ejs**
```html
        <div class="ui minimal comments">
            <h4 class="ui dividing header">留言的留言</h4>
            <% comment.comment2s.forEach(function (comment2) { %>
                <div class="comment">
                    <span class="avatar">
                        <img src="/img/<%= comment2.author.avatar %>">
                    </span>
                    <div class="content">
                        <a class="author" href="/posts?author=<%= comment2.author._id %>"><%= comment.author.name %></a>
                        <div class="metadata">
                            <span class="date"><%= comment2.created_at %></span>
                        </div>
                        <div class="text"><%- comment2.content %></div>    
                        <% if (user && user._id.toString() === comment2.author._id.toString()) { %>                       
                        <div class="actions">                    
                            <a class="reply" href="/comment2s/<%= comment2._id %>/remove">删除</a>                                            
                        </div>  
                        <% } %>               
                    </div>
                </div>              
                <% }) %> 
            <% if (user) { %>
            <form class="ui reply form" method="post" action="/comment2s">
                <input name="commentId" value="<%= comment._id %>" hidden>
                <input name="postId" value="<%= post._id %>" hidden>
                <div class="field">
                <textarea name="content"></textarea>
                </div>
                <input type="submit" class="ui icon button" value="留言" />
            </form>
            <% } %>
        </div>
```
然后在每条评论下方增加二级评论组件，修改 views\components\comments.ejs

**views\components\comments.ejs**
```html
<%- include('comment2s', { comment: comment }) %>
```
## models 设计
新建 models\comment2s.js

**models\comment2s.js**
```js
const express = require('express')
const router = express.Router()

const checkLogin = require('../middlewares/check').checkLogin
const Comment2Model = require('../models/comment2s')

// POST /comment2s 创建一条留言
router.post('/', checkLogin, function (req, res, next) {
  const author = req.session.user._id
  const commentId = req.fields.commentId
  const postId = req.fields.postId
  const content = req.fields.content

  // 校验参数
  try {
    if (!content.length) {
      throw new Error('请填写留言内容')
    }
  } catch (e) {
    req.flash('error', e.message)
    return res.redirect('back')
  }

  const comment = {
    author: author,
    commentId: commentId,
    postId: postId,
    content: content
  }

  Comment2Model.create(comment)
    .then(function () {
      req.flash('success', '留言成功')
      // 留言成功后跳转到上一页
      res.redirect('back')
    })
    .catch(next)
})

// GET /comment2s/:commentId/remove 删除一条留言
router.get('/:comment2Id/remove', checkLogin, function (req, res, next) {
  const comment2Id = req.params.comment2Id
  const author = req.session.user._id

  Comment2Model.getCommentById(comment2Id)
    .then(function (comment) {
      if (!comment) {
        throw new Error('留言不存在')
      }
      if (comment.author.toString() !== author.toString()) {
        throw new Error('没有权限删除留言')
      }
      Comment2Model.delCommentById(comment2Id)
        .then(function () {
          req.flash('success', '删除留言成功')
          // 删除成功后跳转到上一页
          res.redirect('back')
        })
        .catch(next)
    })
})

module.exports = router

```

修改 models\comments.js，为 Comment 添加二级留言明细的插件，添加如下代码：

**models\comments.js**
```js
const Comment2Model = require('./comment2s')

// 给 comments 添加 comment2s
Comment.plugin('addComment2s', {
  afterFind: function (comments) {
    return Promise.all(comments.map(function (comment) {
      return Comment2Model.getComments(comment._id).then(function (comment2s) {
        comment.comment2s = comment2s
        return comment
      })
    }))
  },
  afterFindOne: function (comment) {    
    if (comment) {
      return Comment2Model.getComments(comment._id).then(function (comment2s) {
        comment.comment2s = comment2s
        return comment
      })
    }
    return comment
  }
})
```
同时在 getComments 函数中增加该插件操作，修改代码如下
```js
  // 通过文章 id 获取该文章下所有留言，按留言创建时间升序
  getComments: function getComments (postId) {
    return Comment
      .find({ postId: postId })
      .populate({ path: 'author', model: 'User' })
      .sort({ _id: 1 })
      .addCreatedAt()
      .addComment2s() //增加二级留言
      .contentToHtml()
      .exec()
  },
```
然后修改 delCommentById 函数，使得删除留言时同时删除其二级留言，修改代码如下
```js
// 通过留言 id 删除一个留言
  delCommentById: function delCommentById (commentId) {
    return Comment.deleteOne({ _id: commentId }).exec()
      .then(function (res) {
        // 留言删除后，再删除该留言下的所有二级留言
        if (res.result.ok && res.result.n > 0) {
          return Comment2Model.delComment2sByCommentId(commentId)
        }
      })        
  },
```
修改 models\posts.js，使得删除文章时，除删除留言外，同时删除二级留言，新增及修改代码如下

**models\posts.js**
```js
const Comment2Model = require('./comment2s')

  // 通过文章 id 删除一篇文章
  delPostById: function delPostById (postId, author) {
    console.log(postId,author)
    return Post.deleteOne({ author: author, _id: postId })
      .exec()
      .then(function (res) {
        // 文章删除后，再删除该文章下的所有留言和2及留言
        if (res.result.ok && res.result.n > 0) {
          return Promise.all([
            CommentModel.delCommentsByPostId(postId),
            Comment2Model.delComment2sByPostId(postId)
          ])
        }
      })
  }
```
## 路由设计
新增 routes\comment2s.js

**routes\comment2s.js**
```js
const express = require('express')
const router = express.Router()

const checkLogin = require('../middlewares/check').checkLogin
const Comment2Model = require('../models/comment2s')

// POST /comment2s 创建一条留言
router.post('/', checkLogin, function (req, res, next) {
  const author = req.session.user._id
  const commentId = req.fields.commentId
  const postId = req.fields.postId
  const content = req.fields.content

  // 校验参数
  try {
    if (!content.length) {
      throw new Error('请填写留言内容')
    }
  } catch (e) {
    req.flash('error', e.message)
    return res.redirect('back')
  }

  const comment = {
    author: author,
    commentId: commentId,
    postId: postId,
    content: content
  }

  Comment2Model.create(comment)
    .then(function () {
      req.flash('success', '留言成功')
      // 留言成功后跳转到上一页
      res.redirect('back')
    })
    .catch(next)
})

// GET /comment2s/:commentId/remove 删除一条留言
router.get('/:comment2Id/remove', checkLogin, function (req, res, next) {
  const comment2Id = req.params.comment2Id
  const author = req.session.user._id

  Comment2Model.getCommentById(comment2Id)
    .then(function (comment) {
      if (!comment) {
        throw new Error('留言不存在')
      }
      if (comment.author.toString() !== author.toString()) {
        throw new Error('没有权限删除留言')
      }
      Comment2Model.delCommentById(comment2Id)
        .then(function () {
          req.flash('success', '删除留言成功')
          // 删除成功后跳转到上一页
          res.redirect('back')
        })
        .catch(next)
    })
})

module.exports = router

```
修改 routes\index.js, 路由中加上

**routes\index.js**
```js
    app.use('/comment2s', require('./comment2s'))
```
